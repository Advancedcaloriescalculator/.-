<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spin2Earn - Win Hypa Points</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-analytics-compat.js"></script>
    <style>
        /* Your existing CSS styles remain unchanged */
        /* ... All the existing CSS code ... */
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains unchanged -->
    <!-- ... All the existing HTML code ... -->

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDW79e_zlgBU3hMYyotx0e-X2mlpnNpRqw",
            authDomain: "spin2earn-ce21d.firebaseapp.com",
            databaseURL: "https://spin2earn-ce21d-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "spin2earn-ce21d",
            storageBucket: "spin2earn-ce21d.firebasestorage.app",
            messagingSenderId: "453937952363",
            appId: "1:453937952363:web:abc3f469fd2d514cb8a32e",
            measurementId: "G-NK7VJ1GCGW"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const auth = firebase.auth();
        const database = firebase.database();
        
        // DOM Elements
        const splashScreen = document.getElementById('splash-screen');
        const loginModal = document.getElementById('login-modal');
        const closeLogin = document.getElementById('close-login');
        const googleLogin = document.getElementById('google-login');
        const emailLogin = document.getElementById('email-login');
        const guestLogin = document.getElementById('guest-login');
        const pointsDisplay = document.getElementById('points-display');
        const giftBox = document.getElementById('gift-box');
        const giftTimer = document.getElementById('gift-timer');
        const userAvatar = document.getElementById('user-avatar');
        const dropdownMenu = document.getElementById('dropdown-menu');
        const logoutBtn = document.getElementById('logout-btn');
        const wheel = document.getElementById('wheel');
        const spinBtn = document.getElementById('spin-btn');
        const resultPopup = document.getElementById('result-popup');
        const resultPoints = document.getElementById('result-points');
        const closePopup = document.getElementById('close-popup');
        const referralCode = document.getElementById('referral-code');
        const copyBtn = document.getElementById('copy-btn');
        const referralCount = document.getElementById('referral-count');
        const referralEarnings = document.getElementById('referral-earnings');
        const walletBalance = document.getElementById('wallet-balance');
        const redeemOptions = document.querySelectorAll('.redeem-option');
        const withdrawalMethod = document.getElementById('withdrawal-method');
        const upiField = document.getElementById('upi-field');
        const withdrawalAmount = document.getElementById('withdrawal-amount');
        const withdrawalBtn = document.getElementById('withdrawal-btn');
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');
        const notification = document.getElementById('notification');
        
        // App State
        let userPoints = 0;
        let spinInProgress = false;
        let selectedRedeemAmount = 5;
        let selectedRedeemPoints = 3000;
        let isLoggedIn = false;
        let giftAvailable = false;
        let currentUser = null;
        let userRef = null;
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    isLoggedIn = true;
                    userRef = database.ref('users/' + user.uid);
                    
                    // Load user data from Firebase
                    userRef.once('value').then((snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            userPoints = userData.points || 0;
                            updatePointsDisplay();
                            
                            // Set up real-time listener for points
                            userRef.on('value', (snapshot) => {
                                const data = snapshot.val();
                                if (data && data.points !== undefined) {
                                    userPoints = data.points;
                                    updatePointsDisplay();
                                }
                            });
                            
                            // Update UI with user info
                            userAvatar.textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
                            
                            // Check if gift is available
                            if (userData.lastGiftTime) {
                                const lastGiftTime = new Date(userData.lastGiftTime);
                                const now = new Date();
                                const diffHours = (now - lastGiftTime) / (1000 * 60 * 60);
                                
                                if (diffHours < 24) {
                                    giftBox.classList.add('disabled');
                                    giftAvailable = false;
                                    // Start timer for remaining time
                                    startGiftTimer(24 - Math.floor(diffHours));
                                } else {
                                    giftBox.classList.remove('disabled');
                                    giftAvailable = true;
                                }
                            }
                            
                            // Update referral data
                            if (userData.referrals) {
                                referralCount.textContent = Object.keys(userData.referrals).length;
                                referralEarnings.textContent = Object.keys(userData.referrals).length * 100;
                            }
                            
                            // Generate referral code if not exists
                            if (!userData.referralCode) {
                                const code = generateReferralCode();
                                userRef.update({ referralCode: code });
                                referralCode.textContent = code;
                            } else {
                                referralCode.textContent = userData.referralCode;
                            }
                        } else {
                            // First time user - initialize data
                            const code = generateReferralCode();
                            userRef.set({
                                points: 0,
                                referralCode: code,
                                referrals: {},
                                lastGiftTime: null
                            });
                            referralCode.textContent = code;
                        }
                    });
                    
                    // Hide login modal
                    loginModal.classList.remove('show');
                } else {
                    // User is signed out
                    isLoggedIn = false;
                    currentUser = null;
                    userRef = null;
                    // Show login modal after splash screen
                    setTimeout(() => {
                        loginModal.classList.add('show');
                    }, 500);
                }
                
                updateFeatureAccess();
            });
            
            // Hide splash screen after 3 seconds
            setTimeout(() => {
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                }, 500);
            }, 3000);
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize UI state
            updatePointsDisplay();
            withdrawalAmount.value = `â‚¹${selectedRedeemAmount}`;
        });
        
        function setupEventListeners() {
            // Login modal
            closeLogin.addEventListener('click', () => {
                loginModal.classList.remove('show');
            });
            
            googleLogin.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // User signed in successfully
                        analytics.logEvent('login', { method: 'google' });
                    })
                    .catch((error) => {
                        console.error('Google login error:', error);
                        showNotification('Failed to sign in with Google', 'error');
                    });
            });
            
            emailLogin.addEventListener('click', () => {
                // Simple email/password auth for demo
                const email = prompt('Enter your email:');
                if (email) {
                    const password = prompt('Enter a password:');
                    if (password) {
                        auth.createUserWithEmailAndPassword(email, password)
                            .then((userCredential) => {
                                // User created and signed in
                                analytics.logEvent('sign_up', { method: 'email' });
                            })
                            .catch((error) => {
                                // If user already exists, try to sign in
                                if (error.code === 'auth/email-already-in-use') {
                                    auth.signInWithEmailAndPassword(email, password)
                                        .then((userCredential) => {
                                            // User signed in
                                        })
                                        .catch((error) => {
                                            console.error('Email login error:', error);
                                            showNotification('Failed to sign in with email', 'error');
                                        });
                                } else {
                                    console.error('Email signup error:', error);
                                    showNotification('Failed to create account', 'error');
                                }
                            });
                    }
                }
            });
            
            guestLogin.addEventListener('click', () => {
                // Anonymous auth for guest users
                auth.signInAnonymously()
                    .then((userCredential) => {
                        analytics.logEvent('login', { method: 'anonymous' });
                    })
                    .catch((error) => {
                        console.error('Anonymous login error:', error);
                        showNotification('Failed to sign in as guest', 'error');
                    });
            });
            
            // User menu
            userAvatar.addEventListener('click', () => {
                if (isLoggedIn) {
                    dropdownMenu.classList.toggle('show');
                } else {
                    loginModal.classList.add('show');
                }
            });
            
            logoutBtn.addEventListener('click', () => {
                auth.signOut().then(() => {
                    showNotification('You have been logged out', 'success');
                }).catch((error) => {
                    console.error('Logout error:', error);
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!userAvatar.contains(e.target) && !dropdownMenu.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });
            
            // Spin button
            spinBtn.addEventListener('click', startSpin);
            
            // Close popup
            closePopup.addEventListener('click', () => {
                resultPopup.classList.remove('show');
            });
            
            // Copy referral code
            copyBtn.addEventListener('click', () => {
                if (!isLoggedIn) {
                    showNotification('Please log in to copy referral code', 'error');
                    loginModal.classList.add('show');
                    return;
                }
                
                navigator.clipboard.writeText(referralCode.textContent)
                    .then(() => {
                        copyBtn.textContent = 'Copied!';
                        copyBtn.classList.add('copied');
                        setTimeout(() => {
                            copyBtn.textContent = 'Copy Referral Code';
                            copyBtn.classList.remove('copied');
                        }, 2000);
                        showNotification('Referral code copied to clipboard', 'success');
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        showNotification('Failed to copy referral code', 'error');
                    });
            });
            
            // Gift box
            giftBox.addEventListener('click', openGiftBox);
            
            // Redeem options
            redeemOptions.forEach(option => {
                option.addEventListener('click', () => {
                    if (!isLoggedIn) {
                        showNotification('Please log in to select redemption options', 'error');
                        loginModal.classList.add('show');
                        return;
                    }
                    
                    // Remove selected class from all options
                    redeemOptions.forEach(opt => opt.classList.remove('selected'));
                    
                    // Add selected class to selected option
                    option.classList.add('selected');
                    
                    // Update selected amount
                    selectedRedeemAmount = option.getAttribute('data-amount');
                    selectedRedeemPoints = option.getAttribute('data-points');
                    withdrawalAmount.value = `â‚¹${selectedRedeemAmount}`;
                });
            });
            
            // Withdrawal method change
            withdrawalMethod.addEventListener('change', () => {
                if (withdrawalMethod.value === 'upi') {
                    upiField.style.display = 'block';
                } else {
                    upiField.style.display = 'none';
                }
            });
            
            // Withdrawal request
            withdrawalBtn.addEventListener('click', submitWithdrawal);
            
            // Navigation
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const tabId = item.getAttribute('data-tab');
                    
                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show corresponding tab content
                    tabContents.forEach(tab => tab.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function updateFeatureAccess() {
            if (isLoggedIn) {
                spinBtn.disabled = false;
                copyBtn.disabled = false;
                withdrawalBtn.disabled = false;
                if (giftAvailable) {
                    giftBox.classList.remove('disabled');
                }
            } else {
                spinBtn.disabled = true;
                copyBtn.disabled = true;
                withdrawalBtn.disabled = true;
                giftBox.classList.add('disabled');
                giftAvailable = false;
            }
        }
        
        function startSpin() {
            if (spinInProgress) return;
            if (!isLoggedIn) {
                showNotification('Please log in to spin the wheel', 'error');
                loginModal.classList.add('show');
                return;
            }
            
            spinInProgress = true;
            spinBtn.disabled = true;
            
            // In a real app, show an ad here before spinning
            // For demo, we'll simulate ad with a timeout
            showNotification('Showing advertisement...', 'success');
            
            setTimeout(() => {
                // Generate random result
                const results = [
                    { text: "20 Points", value: 20, color: "#ff7675" },
                    { text: "40 Points", value: 40, color: "#74b9ff" },
                    { text: "60 Points", value: 60, color: "#55efc4" },
                    { text: "80 Points", value: 80, color: "#ffeaa7" },
                    { text: "100 Points", value: 100, color: "#a29bfe" },
                    { text: "Try Again", value: 0, color: "#fd79a8" }
                ];
                
                const randomIndex = Math.floor(Math.random() * results.length);
                const result = results[randomIndex];
                
                // Calculate rotation for the wheel (each segment is 60 degrees)
                const segmentAngle = 60;
                const extraRotation = 5 * 360; // 5 full rotations for effect
                const targetRotation = extraRotation + (randomIndex * segmentAngle) + (Math.random() * segmentAngle);
                
                // Apply rotation to wheel
                wheel.style.transform = `rotate(${targetRotation}deg)`;
                wheel.classList.add('wheel-spinning');
                
                // Show result after animation completes
                setTimeout(() => {
                    wheel.classList.remove('wheel-spinning');
                    
                    if (result.value > 0) {
                        // Update points in Firebase
                        const newPoints = userPoints + result.value;
                        userRef.update({ points: newPoints })
                            .then(() => {
                                // Show result popup
                                resultPoints.textContent = result.text;
                                resultPopup.classList.add('show');
                                showNotification(`You won ${result.text}!`, 'success');
                                analytics.logEvent('spin_wheel', { points_won: result.value });
                            })
                            .catch((error) => {
                                console.error('Error updating points:', error);
                                showNotification('Error updating points', 'error');
                            });
                    } else {
                        // Try again - no points awarded
                        showNotification("Try Again! Better luck next time.", 'error');
                    }
                    
                    spinInProgress = false;
                    spinBtn.disabled = false;
                }, 3000);
            }, 1500); // Simulated ad delay
        }
        
        function openGiftBox() {
            if (!isLoggedIn) {
                showNotification('Please log in to open the gift box', 'error');
                loginModal.classList.add('show');
                return;
            }
            
            if (giftBox.classList.contains('disabled')) return;
            
            // In a real app, show an ad here before opening gift
            // For demo, we'll simulate ad with a timeout
            showNotification('Showing advertisement...', 'success');
            
            setTimeout(() => {
                // Random points: 20 or 40
                const giftPoints = Math.random() > 0.5 ? 20 : 40;
                
                // Update points in Firebase and set last gift time
                const newPoints = userPoints + giftPoints;
                const now = new Date().toISOString();
                
                userRef.update({ 
                    points: newPoints,
                    lastGiftTime: now
                })
                .then(() => {
                    // Show result
                    resultPoints.textContent = `${giftPoints} Points`;
                    resultPopup.classList.add('show');
                    showNotification(`You received ${giftPoints} points from the gift box!`, 'success');
                    analytics.logEvent('open_gift', { points_received: giftPoints });
                    
                    // Disable gift box for 24 hours
                    giftBox.classList.add('disabled');
                    giftAvailable = false;
                    startGiftTimer(24);
                })
                .catch((error) => {
                    console.error('Error updating gift points:', error);
                    showNotification('Error opening gift box', 'error');
                });
            }, 1500); // Simulated ad delay
        }
        
        function startGiftTimer(hours) {
            let remainingHours = hours;
            let minutes = 0;
            let seconds = 0;
            
            const updateTimer = () => {
                if (remainingHours === 0 && minutes === 0 && seconds === 0) {
                    giftBox.classList.remove('disabled');
                    giftAvailable = true;
                    giftTimer.textContent = "ðŸŽ";
                    showNotification('Gift box is available again!', 'success');
                    return;
                }
                
                if (seconds === 0) {
                    if (minutes === 0) {
                        remainingHours--;
                        minutes = 59;
                    } else {
                        minutes--;
                    }
                    seconds = 59;
                } else {
                    seconds--;
                }
                
                // Format timer display
                if (remainingHours > 0) {
                    giftTimer.textContent = `${remainingHours}h`;
                } else if (minutes > 0) {
                    giftTimer.textContent = `${minutes}m`;
                } else {
                    giftTimer.textContent = `${seconds}s`;
                }
                
                setTimeout(updateTimer, 1000);
            };
            
            updateTimer();
        }
        
        function updatePointsDisplay() {
            pointsDisplay.textContent = `${userPoints} Hypa Points`;
            walletBalance.textContent = userPoints;
        }
        
        function submitWithdrawal() {
            if (!isLoggedIn) {
                showNotification('Please log in to submit a withdrawal', 'error');
                loginModal.classList.add('show');
                return;
            }
            
            if (userPoints < selectedRedeemPoints) {
                showNotification(`You need at least ${selectedRedeemPoints} points to redeem â‚¹${selectedRedeemAmount}`, 'error');
                return;
            }
            
            const method = withdrawalMethod.value;
            const upiId = document.getElementById('upi-id').value;
            
            if (method === 'upi' && !upiId) {
                showNotification('Please enter your UPI ID', 'error');
                return;
            }
            
            // Create withdrawal request in Firebase
            const withdrawalRef = database.ref('withdrawals').push();
            const withdrawalData = {
                userId: currentUser.uid,
                amount: selectedRedeemAmount,
                points: selectedRedeemPoints,
                method: method,
                upiId: method === 'upi' ? upiId : null,
                status: 'pending',
                timestamp: new Date().toISOString()
            };
            
            withdrawalRef.set(withdrawalData)
                .then(() => {
                    // Deduct points
                    const newPoints = userPoints - selectedRedeemPoints;
                    userRef.update({ points: newPoints })
                        .then(() => {
                            showNotification(`Withdrawal request submitted for â‚¹${selectedRedeemAmount}. It will be processed within 24 hours.`, 'success');
                            analytics.logEvent('withdrawal_request', { amount: selectedRedeemAmount });
                            
                            // Reset form
                            document.getElementById('upi-id').value = '';
                            redeemOptions.forEach(opt => opt.classList.remove('selected'));
                            selectedRedeemAmount = 5;
                            selectedRedeemPoints = 3000;
                            withdrawalAmount.value = `â‚¹${selectedRedeemAmount}`;
                        })
                        .catch((error) => {
                            console.error('Error deducting points:', error);
                            showNotification('Error processing withdrawal', 'error');
                        });
                })
                .catch((error) => {
                    console.error('Error submitting withdrawal:', error);
                    showNotification('Error submitting withdrawal request', 'error');
                });
        }
        
        function generateReferralCode() {
            return 'SPIN' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationText = notification.querySelector('.notification-text');
            const notificationIcon = notification.querySelector('.notification-icon');
            
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            
            if (type === 'success') {
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            } else {
                notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>